#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
Build CoT-style JSONL for TAQEEM2025 Task B.

Reads:
  - TAQEEM2025_TaskB_train_essays.json
  - TAQEEM2025_TaskB_train_prompts.json
  - TAQEEM2025_TaskB_train_human_scores.csv

Writes:
  - taqeem_train_CoT.jsonl

Usage:
  python taqeem_build_cot_jsonl.py \

    --essays TAQEEM2025_TaskB_train_essays.json \

    --prompts TAQEEM2025_TaskB_train_prompts.json \

    --scores  TAQEEM2025_TaskB_train_human_scores.csv \

    --out     taqeem_train_CoT.jsonl
"""
import argparse
import json
import pandas as pd
from typing import Dict, Any

ZERO_REASON = (
    "يعطى درجة (0) إذا كانت الاستجابة محفوظة بالكامل أو نسخت من الموضوع أو "
    "لم يحاول الطالب تنفيذ المهمة أو كتب ما ليس له صلة بالموضوع المطلوب"
)

# === Rubrics (official Arabic snippets) ===
RUBRICS: Dict[str, Dict[int, str]] = {
    "relevance": {
        0: ZERO_REASON,
        1: "له صلة بالموضوع بشكل جزئي",
        2: "له صلة بالموضوع بشكل كامل"
    },
    "organization": {
        0: ZERO_REASON,
        1: "المقدمة والخاتمة قد تغيب عن النص، وعرض يفتقر إلى التنظيم والتسلسل بين الفقرات.",
        2: "المقدمة أو الخاتمة قد تغيب عن النص، وعرض يفتقر إلى التنظيم والتسلسل بين الفقرات.",
        3: "النص مقبول التنظيم يحتوي على مقدمة وخاتمة، وعرض يحتوي على فقرة واحدة (أو فقرتين) يعوزهما حسن الترابط.",
        4: "النص جيد التنظيم يحتوي على مقدمة تمهد للموضوع وخاتمة مناسبة، وعرض يحتوي على فقرتين إلى ثلاث تتسمان بالتسلسل والترابط.",
        5: "النص جيد التنظيم يحتوي مقدمة تمهد للموضوع وخاتمة تقود إلى خلاصات فعالة، وعرض يحتوي فقرتين إلى ثلاث تتسم بالتسلسل والترابط الجيد."
    },
    "vocabulary": {
        0: ZERO_REASON,
        1: "استخدام مدى محدود من المفردات والعبارات لا تشكل مع بعضها معنى سليم، مع شيوع التكرار والأخطاء المعجمية، واختيار غير مناسب بشكل عام للمفردات والذي يحجب المعنى.",
        2: "استخدام مدى أساسي من المفردات مع وجود تكرار وأخطاء معجمية، والعديد من اختيارات المفردات غير المناسبة والتي قد تحجب المعنى.",
        3: "استخدام مدى كافٍ من المفردات مع وجود بعض التكرار والأخطاء المعجمية، واختيار عدد قليل من المفردات غير المناسبة والتي قد تحجب المعنى.",
        4: "استخدام مدى جيد ومناسب من المفردات مع وجود أخطاء معجمية قليلة، واختيار غير مناسب للمفردات دون تأثير على المعنى، واستخدام عرضي للتعبيرات الاصطلاحية.",
        5: "استخدام مدى واسع صحيح ومناسب من المفردات مع وجود أخطاء قليلة بشكل عرضي، وإلمام جيد بالتعبيرات الاصطلاحية وإدراك مستويات المعنى الضمنية."
    },
    "style": {
        0: ZERO_REASON,
        1: "ربط الكلمات أو مجموعات الكلمات بروابط خطية أساسية جدًّا فقط مثل: 'و' أو 'ثم'.",
        2: "تطور الخطاب في شكل قائمة بسيطة من النقاط باستخدام الروابط الأكثر شيوعًا فقط.",
        3: "تطور الخطاب بشكل مباشر كتسلسل خطي من النقاط باستخدام أدوات تماسك بنائي شائعة.",
        4: "تطور الخطاب بشكل واضح مع النقاط الرئيسة المدعمة بالتفاصيل ذات الصلة، واستخدام مناسب دائمًا للأنماط التنظيمية المختلفة ومجموعة من أدوات التماسك البنائي مع 'القفز' العرضي في الجمل الطويلة.",
        5: "تطور الخطاب بشكل متقن مع تضمين الموضوعات الفرعية والتفاصيل بشكلٍ جيد واستنتاج جيد، واستخدام مناسب دائمًا لمجموعة متنوعة من الأنماط التنظيمية ومجموعة واسعة من أدوات التماسك البنائي."
    },
    "development": {
        0: ZERO_REASON,
        1: "المضمون لا يرتبط بموضوع السؤال، والأفكار عشوائية لا رابط بينها، وتختفي تمامًا الفكرة الرئيسية ولا تظهر في النص.",
        2: "المضمون يرتبط نسبيًا بموضوع السؤال، والأفكار ترتبط بعضها، ويتسم بالتنظيم والتسلسل في بعض المواضع، مع وجود ظهور للفكرة الرئيسية، ويختفي تدعيم النص بأفكار أو تفسيرات.",
        3: "المضمون يرتبط تمامًا بموضوع السؤال، والفكرة الرئيسية ظاهرة في أغلب أجزاء النص، مع وجود تنظيم لبعض المعلومات وربطها ببعضها.",
        4: "المضمون يرتبط تمامًا بموضوع السؤال، وتتسم الأفكار بالوضوح والتنظيم والتسلسل والترابط، مع الحفاظ على استمرارية الفكرة الرئيسية ودعم المعلومات ببعض الأفكار أو التفسيرات.",
        5: "المضمون يرتبط تمامًا بموضوع النص، وتتسم الأفكار بالوضوح والتنظيم والتسلسل والترابط، مع دعم الآراء بتفسيرات منطقية واستخدام وسائل تزيد من وضوح عرض الحقائق."
    },
    "mechanics": {
        0: ZERO_REASON,
        1: "تطبيق محدود للقواعد الإملائية.",
        2: "تكرار الأخطاء الإملائية وعلامات الترقيم.",
        3: "التطبيق الفعال للتنسيق القياسي والفقرات والهجاء وعلامات الترقيم في معظم الأوقات.",
        4: "تطبيق فعال للتنسيق القياسي والهجاء وعلامات الترقيم مع وجود أخطاء قليلة.",
        5: "تنظيم فقرات وعلامات ترقيم وهجاء دقيقة بشكل كامل باستثناء زلات قليلة عرضية."
    },
    "grammar": {
        0: ZERO_REASON,
        1: "استخدام مجموعة محدودة من التراكيب النحوية البسيطة مع القليل من المرونة والدقة.",
        2: "استخدام صحيح لبعض التراكيب النحوية البسيطة مع أخطاء منهجية متكررة.",
        3: "استخدام تراكيب نحوية متنوعة مع وجود أخطاء ملحوظة وعدم الدقة.",
        4: "استخدام جيد لمجموعة متنوعة من التراكيب النحوية مع وجود أخطاء نادرة لا تؤثر على المعنى.",
        5: "استخدام صحيح ومرن دائمًا لمجموعة متنوعة من التراكيب النحوية مع زلات بسيطة عرضية."
    }
}

# === CoT prompts by trait ===
COT_PROMPTS: Dict[str, str] = {
    "relevance":
        "لتقييم الصلة بالموضوع، اتبع الخطوات التالية بعناية:\n"
        "1. اقرأ نص المقال كاملًا بعناية شديدة.\n"
        "2. حدد موضوع السؤال أو المحور المطلوب في التعليمات الأصلية.\n"
        "3. تحقق مما إذا كانت جميع أجزاء المقال تتعلق بالموضوع المطلوب، أو أن بعضها فقط له صلة، أو أن النص بالكامل لا علاقة له بالموضوع.\n"
        "4. انتبه إذا كان النص منسوخًا أو محفوظًا أو مكتوبًا بلا محاولة للإجابة على السؤال.\n"
        "5. بناءً على الخطوات السابقة، اختر الدرجة المناسبة من (0) إلى (2) حسب المقياس الرسمي:\n"
        "   - (0): إذا لم يحاول الطالب الإجابة أو كتب نصًا محفوظًا أو لا علاقة له بالموضوع.\n"
        "   - (1): إذا كان للنص صلة جزئية بالموضوع فقط.\n"
        "   - (2): إذا كان للنص صلة كاملة بالموضوع المطلوب.\n"
        "6. في النهاية، أعطِ درجة الصلة بالموضوع مع التبرير وفقًا للمقياس الرسمي.",
    "organization":
        "لتقييم الهيكل العام والتنظيم، اتبع الخطوات التالية بعناية:\n"
        "1. اقرأ نص المقال بعناية وحدد إذا كان يتضمن مقدمة واضحة تعرض الموضوع.\n"
        "2. افحص هيكل المقال: هل يحتوي على فقرات منظمة تتبع تسلسلاً منطقياً؟\n"
        "3. تحقق من وجود خاتمة تلخص الأفكار الرئيسية أو تقدم استنتاجاً مناسباً.\n"
        "4. راقب مدى ترابط الفقرات وتدرج الأفكار من البداية إلى النهاية، وهل هناك تنظيم وتسلسل واضحان.\n"
        "5. لاحظ أي نقص في المقدمة أو الخاتمة أو ضعف في ترابط العرض بين الفقرات.\n"
        "6. استعن بالمقياس الرسمي وحدد الدرجة الأنسب من (0) إلى (5) بناءً على جودة التنظيم.\n"
        "7. في النهاية، أعط درجة التنظيم المناسبة وقدم تبريرك بناءً على المقياس الرسمي.",
    "vocabulary":
        "لتقييم المفردات المستخدمة في هذا النص، اتبع الخطوات التالية بعناية:\n"
        "1. اقرأ نص المقال كاملًا وركز على الكلمات والعبارات المستخدمة.\n"
        "2. قيّم مدى تنوع المفردات: هل هناك تكرار كبير أم استخدام جيد لمجموعة متنوعة من الكلمات؟\n"
        "3. تحقق من ملاءمة المفردات للمعنى: هل اختيار الكلمات صحيح ومناسب للموضوع، أم أن هناك كلمات غير مناسبة تحجب أو تضعف المعنى؟\n"
        "4. لاحظ وجود أخطاء معجمية: هل هناك كلمات تم استخدامها في غير موضعها أو بشكل غير صحيح؟\n"
        "5. انتبه لاستخدام التعبيرات الاصطلاحية أو العبارات المركبة وهل تم توظيفها بشكل جيد.\n"
        "6. بناءً على الملاحظات السابقة، حدد الدرجة المناسبة من (0) إلى (5) حسب المقياس الرسمي.\n"
        "7. في النهاية، أعط درجة المفردات المناسبة وقدم تبريرك بناءً على المقياس الرسمي.",
    "style":
        "لتقييم الأسلوب والتماسك البنائي في هذا النص، اتبع الخطوات التالية بعناية:\n"
        "1. اقرأ نص المقال كاملًا وركز على كيفية ربط الجمل والأفكار ببعضها.\n"
        "2. تحقق من استخدام أدوات الربط (مثل: و، ثم، لذلك، بالإضافة إلى...) ومدى تنوعها في النص.\n"
        "3. لاحظ إذا كانت الأفكار معروضة بشكل قائمة فقط أم تم تسلسلها وتطويرها بوضوح.\n"
        "4. قيّم مدى وضوح وترابط الخطاب: هل هناك تسلسل منطقي للأفكار وهل يتم دعم النقاط الرئيسية بتفاصيل ذات صلة؟\n"
        "5. انتبه لوجود \"قفزات\" أو انقطاعات في ترابط الجمل أو الفقرات.\n"
        "6. تحقق من وجود تنظيمات أسلوبية متنوعة (مثل: الاستنتاج، الأمثلة، الأسباب) واستخدام تعبيرات مناسبة حسب السياق.\n"
        "7. بناءً على الملاحظات السابقة، حدد الدرجة المناسبة من (0) إلى (5) حسب المقياس الرسمي.\n"
        "8. في النهاية، أعط درجة الأسلوب المناسبة وقدم تبريرك بناءً على المقياس الرسمي.",
    "development":
        "لتقييم الأفكار والمضمون في هذا النص، اتبع الخطوات التالية بعناية:\n"
        "1. اقرأ نص المقال كاملًا وركز على مضمون الإجابة والأفكار المطروحة.\n"
        "2. حدد إذا كان المضمون مرتبطًا بموضوع السؤال، أو أن الأفكار عشوائية ولا رابط بينها.\n"
        "3. تحقق من وجود فكرة رئيسية واضحة في النص، وهل تظهر في جميع أجزائه أم تختفي في بعضها.\n"
        "4. لاحظ مدى تنظيم وتسلسل الأفكار، وهل هناك ترابط بين الجمل والفقرات.\n"
        "5. قيّم مدى دعم المعلومات المقدمة بأفكار أو تفسيرات منطقية، وهل يتم توضيح الحقائق أو دعم الآراء بأمثلة أو تبريرات.\n"
        "6. راقب إذا كان النص يحتوي على تكرار أو حشو غير ضروري أو أفكار لا ترتبط بالسؤال.\n"
        "7. بناءً على الخطوات السابقة، حدد الدرجة الأنسب من (0) إلى (5) حسب المقياس الرسمي.\n"
        "8. في النهاية، أعط درجة للأفكار والمضمون وقدم تبريرك بناءً على المقياس الرسمي.",
    "mechanics":
        "لتقييم الإملاء والترقيم والشكل في هذا النص، اتبع الخطوات التالية بعناية:\n"
        "1. اقرأ نص المقال كاملًا مع التركيز على الكتابة الإملائية وعلامات الترقيم وترتيب الفقرات.\n"
        "2. تحقق من وجود أخطاء إملائية متكررة أو بسيطة، وحدد مدى تأثيرها على وضوح النص.\n"
        "3. راقب استخدام علامات الترقيم (النقطة، الفاصلة، علامة الاستفهام...) ومدى توظيفها بشكل صحيح.\n"
        "4. افحص ترتيب الفقرات والتنسيق العام للنص: هل هناك فقرات واضحة ومنظمة أم النص مكتوب بشكل متصل؟\n"
        "5. لاحظ إذا كان التنسيق والكتابة القياسية (من حيث الحروف والشكل) مطبقًا بشكل جيد أم هناك تجاوزات واضحة.\n"
        "6. بناءً على الخطوات السابقة، حدد الدرجة الأنسب من (0) إلى (5) حسب المقياس الرسمي.\n"
        "7. في النهاية، أعط درجة الإملاء والترقيم والشكل المناسبة وقدم تبريرك بناءً على المقياس الرسمي.",
    "grammar":
        "لتقييم البناء والتراكيب النحوية في هذا النص، اتبع الخطوات التالية بعناية:\n"
        "1. اقرأ نص المقال بعناية مع التركيز على التراكيب النحوية المستخدمة في الجمل.\n"
        "2. لاحظ مدى تنوع التراكيب: هل يقتصر النص على جمل بسيطة فقط أم يستخدم تراكيب متنوعة (جمل مركبة، معترضة، إلخ)؟\n"
        "3. تحقق من مدى دقة استخدام القواعد النحوية: هل توجد أخطاء متكررة تؤثر على وضوح النص أو معناه؟\n"
        "4. راقب المرونة في بناء الجمل: هل يغير الكاتب في صيغ وتركيبات الجمل أم يعتمد على نمط واحد؟\n"
        "5. انتبه إلى الأخطاء النحوية النادرة أو الزلات العرضية التي لا تؤثر على الفهم العام.\n"
        "6. بناءً على الخطوات السابقة، حدد الدرجة الأنسب من (0) إلى (5) حسب المقياس الرسمي.\n"
        "7. في النهاية، أعط درجة البناء والتراكيب المناسبة وقدم تبريرك بناءً على المقياس الرسمي."
}

# Short readable Arabic trait names
TRAIT_NAMES = {
    "relevance": "الصلة بالموضوع",
    "organization": "الهيكل العام",
    "vocabulary": "المفردات",
    "style": "الأسلوب والتماسك البنائي",
    "development": "الأفكار والمضمون",
    "mechanics": "الإملاء والترقيم والشكل",
    "grammar": "البناء والتراكيب"
}

SCORE_RANGES = {
    "relevance": "0-2",
    "organization": "0-5",
    "vocabulary": "0-5",
    "style": "0-5",
    "development": "0-5",
    "mechanics": "0-5",
    "grammar": "0-5"
}

TRAIT_PROMPTS = {
    k: f"ستعمل الآن على تقييم {TRAIT_NAMES[k]} في النص وفقًا لمقياس رسمي. ركز على الجوانب المحددة في التعليمات."
    for k in TRAIT_NAMES
}

TRAITS = ["relevance", "organization", "vocabulary", "style",
          "development", "mechanics", "grammar"]

def zpad_essay_id(x: Any) -> str:
    try:
        return str(x).zfill(6)
    except Exception:
        return str(x)

def build(args: argparse.Namespace) -> None:
    # Load data
    with open(args.essays, "r", encoding="utf-8") as f:
        essays = json.load(f)

    with open(args.prompts, "r", encoding="utf-8") as f:
        prompt_objs = json.load(f)
    prompts = {p["prompt_id"]: p["prompt_text"] for p in prompt_objs}

    scores = pd.read_csv(args.scores, dtype={"essay_id": str, "prompt_id": int})
    scores["essay_id"] = scores["essay_id"].apply(zpad_essay_id)

    written = 0
    skipped = 0
    with open(args.out, "w", encoding="utf-8") as out_f:
        for essay in essays:
            essay_id = zpad_essay_id(essay.get("essay_id"))
            prompt_id = int(essay.get("prompt_id"))
            essay_text = (essay.get("essay") or "").strip()
            prompt_text = prompts.get(prompt_id, "")

            # Gold (human) scores row
            gold_row = scores[(scores["essay_id"] == essay_id) & (scores["prompt_id"] == prompt_id)]
            if gold_row.empty:
                skipped += 1
                continue

            for trait in TRAITS:
                gold_score = int(gold_row.iloc[0][trait])
                trait_rubric = RUBRICS[trait]
                justification = trait_rubric.get(gold_score, ZERO_REASON)

                entry = {
                    "essay_id": essay_id,
                    "prompt_id": prompt_id,
                    "trait": trait,
                    "trait_name": TRAIT_NAMES[trait],
                    "prompt_text": prompt_text,
                    "essay": essay_text,
                    "trait_prompt": TRAIT_PROMPTS[trait],
                    "cot_prompt": COT_PROMPTS[trait],
                    "score_range": SCORE_RANGES[trait],
                    "show_gold": "الآن ستعرض الدرجة الصحيحة والتبرير الرسمي لهذه السمة بناءً على تقييم المصحح البشري والمقياس الرسمي:",
                    "gold_score": gold_score,
                    "justification": justification,
                }
                out_f.write(json.dumps(entry, ensure_ascii=False) + "\n")
                written += 1

    print(f"Done. Wrote {written} lines to {args.out}. Skipped essays with no human score: {skipped}.")

def parse_args() -> argparse.Namespace:
    p = argparse.ArgumentParser(description="Build CoT JSONL for TAQEEM2025 Task B.")
    p.add_argument("--essays", default="TAQEEM2025_TaskB_train_essays.json", type=str)
    p.add_argument("--prompts", default="TAQEEM2025_TaskB_train_prompts.json", type=str)
    p.add_argument("--scores",  default="TAQEEM2025_TaskB_train_human_scores.csv", type=str)
    p.add_argument("--out",     default="taqeem_train_CoT.jsonl", type=str)
    return p.parse_args()

if __name__ == "__main__":
    args = parse_args()
    build(args)
